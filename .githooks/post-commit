#!/bin/bash

# Post-commit hook for comprehensive tracking
COMMIT_MSG=$(git log -1 --pretty=%B)
COMMIT_HASH=$(git rev-parse HEAD)
TIMESTAMP=$(date "+%Y-%m-%d %H:%M:%S")

# 1. Log to session file
echo "[$TIMESTAMP] Commit: $COMMIT_HASH" >> .claude-session.log
echo "  Message: $COMMIT_MSG" >> .claude-session.log

# 2. Track what types of files were changed
FILES_CHANGED=$(git diff-tree --no-commit-id --name-only -r HEAD)
TEST_COUNT=$(echo "$FILES_CHANGED" | grep -E '\.(test|spec)\.(tsx?|jsx?)$' | wc -l | tr -d ' ')
COMPONENT_COUNT=$(echo "$FILES_CHANGED" | grep -E 'components/.*\.tsx$' | grep -v '.test' | wc -l | tr -d ' ')
DOC_COUNT=$(echo "$FILES_CHANGED" | grep -E '\.(md)$' | wc -l | tr -d ' ')

echo "  Changes: $COMPONENT_COUNT components, $TEST_COUNT tests, $DOC_COUNT docs" >> .claude-session.log
echo "" >> .claude-session.log

# 3. Check if documentation should be updated based on changes
SHOULD_UPDATE_DOCS=false
if echo "$COMMIT_MSG" | grep -qE '^(feat|test|refactor|fix):'; then
    SHOULD_UPDATE_DOCS=true
fi

# 4. Provide actionable reminders
echo "âœ… Commit successful!"

if [ $TEST_COUNT -gt 0 ]; then
    echo "ðŸ§ª Test files updated - remember to update testing-strategy.md"
fi

if [ $COMPONENT_COUNT -gt 0 ] && [ $TEST_COUNT -eq 0 ]; then
    echo "âš ï¸  Components changed without test updates - consider adding tests"
fi

if [ "$SHOULD_UPDATE_DOCS" = true ] && [ $DOC_COUNT -eq 0 ]; then
    echo "ðŸ“ Feature/fix committed - consider updating documentation:"
    echo "   - context_recovery.md (current state)"
    echo "   - todo_list.md (mark completed tasks)"
fi

# 5. Auto-reminder for session management
COMMIT_COUNT=$(git rev-list --count HEAD...@{u} 2>/dev/null || echo "0")
if [ "$COMMIT_COUNT" -gt 5 ]; then
    echo "ðŸ’¡ You have $COMMIT_COUNT unpushed commits - consider pushing soon"
fi
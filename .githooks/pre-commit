#!/bin/bash

# Git pre-commit hook for comprehensive checks
echo "üìù Pre-commit checks:"
echo "===================="

# 1. Documentation freshness check
echo ""
echo "üìö Documentation Status:"
for file in context_recovery.md todo_list.md testing-strategy.md CLAUDE.md; do
    if [ -f "$file" ]; then
        AGE=$((($(date +%s) - $(stat -f %m "$file" 2>/dev/null || echo 0)) / 60))
        if [ $AGE -gt 1440 ]; then  # More than 24 hours
            echo "  ‚ùå $file is $((AGE / 1440)) days old - UPDATE NEEDED"
            DOCS_STALE=true
        elif [ $AGE -gt 120 ]; then  # More than 2 hours
            echo "  ‚ö†Ô∏è  $file is $((AGE / 60)) hours old - consider updating"
        else
            echo "  ‚úÖ $file is fresh ($AGE minutes old)"
        fi
    fi
done

# 2. Check if test files were modified
echo ""
echo "üß™ Test File Changes:"
TEST_FILES=$(git diff --cached --name-only | grep -E '\.(test|spec)\.(tsx?|jsx?)$' | wc -l | tr -d ' ')
if [ $TEST_FILES -gt 0 ]; then
    echo "  ‚ö†Ô∏è  $TEST_FILES test file(s) modified - remember to update testing-strategy.md"
    echo "  üìä Run 'npm test' to verify all tests pass"
fi

# 3. Check if components were added without tests
echo ""
echo "üîç Component Coverage Check:"
COMPONENT_FILES=$(git diff --cached --name-only | grep -E 'components/.*\.tsx$' | grep -v '.test.tsx')
for file in $COMPONENT_FILES; do
    TEST_FILE="${file%.tsx}.test.tsx"
    if [ ! -f "$TEST_FILE" ]; then
        echo "  ‚ö†Ô∏è  Missing test for: $file"
        echo "     Expected: $TEST_FILE"
    fi
done

# 4. Count total changes
echo ""
echo "üìä Change Summary:"
MODIFIED=$(git diff --cached --name-only | wc -l | tr -d ' ')
echo "  Total files: $MODIFIED"
echo "  Added: $(git diff --cached --numstat | awk '{sum+=$1} END {print sum}') lines"
echo "  Removed: $(git diff --cached --numstat | awk '{sum+=$2} END {print sum}') lines"

# 5. Check commit threshold (warn if too many changes)
if [ $MODIFIED -gt 10 ]; then
    echo ""
    echo "‚ö†Ô∏è  Large commit detected ($MODIFIED files)"
    echo "   Consider breaking into smaller, focused commits"
fi

# 6. Remind about conventional commits
echo ""
echo "üìã Commit Message Checklist:"
echo "  ‚úì Use conventional format: type(scope): description"
echo "  ‚úì Types: feat, fix, docs, test, refactor, style, chore"
echo "  ‚úì Include Co-Authored-By: Claude <noreply@anthropic.com>"

# Don't block commit, just warn
exit 0